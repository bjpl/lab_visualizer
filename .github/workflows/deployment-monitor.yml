name: Deployment Monitoring

on:
  deployment_status:

permissions:
  contents: read
  deployments: read

jobs:
  monitor-deployment:
    name: Monitor Deployment Health
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Monitor deployment for 5 minutes
        run: node scripts/ci/deployment-monitor.js
        env:
          BASE_URL: ${{ github.event.deployment_status.target_url }}
          MONITOR_DURATION: 300000  # 5 minutes
          CHECK_INTERVAL: 30000     # 30 seconds
          ERROR_THRESHOLD: 0.01     # 1% error rate

      - name: Report monitoring results
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const status = context.payload.workflow_run?.conclusion || 'unknown';
            const deploymentUrl = context.payload.deployment_status?.target_url;

            const message = status === 'success'
              ? `✅ Deployment monitoring passed for ${deploymentUrl}`
              : `⚠️ Deployment monitoring detected issues at ${deploymentUrl}`;

            console.log(message);

            // Optionally create an issue if monitoring fails
            if (status === 'failure') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[ALERT] Deployment Health Issues Detected',
                body: `Deployment monitoring detected issues after deployment.\n\n**URL:** ${deploymentUrl}\n\n**Status:** ${status}\n\nPlease investigate immediately.`,
                labels: ['deployment', 'monitoring', 'alert']
              });
            }
